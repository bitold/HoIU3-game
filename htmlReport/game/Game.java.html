<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Game.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">LAB1 Coverage Results</a> &gt; <a href="index.source.html" class="el_package">game</a> &gt; <span class="el_source">Game.java</span></div><h1>Game.java</h1><pre class="source lang-java linenums">package game;

import asset.*;
import castle.Castle;
import control.Controller;
import map.GameMap;
import menus.ControllerMenu;
import menus.GameMenu;
import misc.Coordinates;
import misc.Misc;
import player.Computer;
import player.Player;

import java.io.*;
import java.util.*;
import java.util.logging.Level;
import java.util.logging.Logger;

public class Game implements Serializable {
<span class="nc" id="L20">    String status = &quot;pregame&quot;; // &quot;pregame&quot; &quot;global&quot; &quot;battle&quot; &quot;endgame&quot;</span>
    GameMap gameMap;
    GameMap battleMap;
    Player currentlyMoving;
<span class="nc" id="L24">    transient Scanner scanner = new Scanner(System.in);</span>
    Player player;
    Computer computer;
    Controller controller;
    ControllerMenu controllerMenu;
    Battle battle;
<span class="nc" id="L30">    ArrayList&lt;Hero&gt; battlers = new ArrayList&lt;&gt;();</span>
    GameMenu gameMenu;
<span class="nc" id="L32">    Set&lt;Player&gt; players = new HashSet&lt;&gt;();</span>
<span class="nc" id="L33">    Set&lt;Player&gt; losers = new HashSet&lt;&gt;();</span>
    private static final long serialVersionUID = 1L;
    boolean freshlyLoaded;

    // Пример метода сохранения игры
    public void saveToSlot(String baseDir, String nickname, int slotNumber) {
<span class="nc" id="L39">        String dirPath = baseDir + &quot;/saves/&quot; + nickname;</span>
<span class="nc" id="L40">        String filePath = dirPath + &quot;/slot&quot; + slotNumber + &quot;.dat&quot;;</span>

        try {
            // Создаем папку игрока, если её нет
<span class="nc" id="L44">            java.nio.file.Files.createDirectories(java.nio.file.Paths.get(dirPath));</span>

            // Сохраняем объект Game в файл
<span class="nc" id="L47">            try (ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(filePath))) {</span>
<span class="nc" id="L48">                oos.writeObject(this);</span>
<span class="nc" id="L49">                Logger.getLogger(Game.class.getName()).log(Level.INFO,</span>
                        &quot;Игра сохранена в слот {0} для игрока {1}&quot;,
<span class="nc" id="L51">                        new Object[]{slotNumber, nickname});</span>
            }
<span class="nc" id="L53">        } catch (IOException e) {</span>
<span class="nc" id="L54">            Logger.getLogger(Game.class.getName()).log(Level.SEVERE,</span>
                    &quot;Ошибка сохранения игры в слот &quot; + slotNumber + &quot; для игрока &quot; + nickname, e);
<span class="nc" id="L56">        }</span>
<span class="nc" id="L57">    }</span>

    public static Game loadFromSlot(String baseDir, String nickname, int slotNumber) {
<span class="nc" id="L60">        String filePath = baseDir + &quot;/saves/&quot; + nickname + &quot;/slot&quot; + slotNumber + &quot;.dat&quot;;</span>

<span class="nc" id="L62">        try (ObjectInputStream ois = new ObjectInputStream(new FileInputStream(filePath))) {</span>
<span class="nc" id="L63">            Game loadedGame = (Game) ois.readObject();</span>
<span class="nc" id="L64">            Logger.getLogger(Game.class.getName()).log(Level.INFO,</span>
                    &quot;Игра загружена из слота {0} для игрока {1}&quot;,
<span class="nc" id="L66">                    new Object[]{slotNumber, nickname});</span>
<span class="nc" id="L67">            return loadedGame;</span>
<span class="nc" id="L68">        } catch (IOException | ClassNotFoundException e) {</span>
<span class="nc" id="L69">            Logger.getLogger(Game.class.getName()).log(Level.SEVERE,</span>
                    &quot;Ошибка загрузки игры из слота &quot; + slotNumber + &quot; для игрока &quot; + nickname, e);
<span class="nc" id="L71">            return null;</span>
        }
    }

<span class="nc" id="L75">    public Game(GameMap map){</span>
<span class="nc" id="L76">        this.gameMap = map;</span>
<span class="nc" id="L77">        this.controller = new Controller(map, this);</span>
<span class="nc" id="L78">        controllerMenu = new ControllerMenu(controller);</span>
<span class="nc" id="L79">        controller.setBattling(false);</span>
<span class="nc" id="L80">        gameMenu = new GameMenu(this);</span>
<span class="nc" id="L81">    }</span>
<span class="nc" id="L82">    public Game(){</span>
<span class="nc" id="L83">        setFreshlyLoaded(true);</span>
<span class="nc" id="L84">    }</span>

    public void setFreshlyLoaded(boolean freshlyLoaded) {
<span class="nc" id="L87">        this.freshlyLoaded = freshlyLoaded;</span>
<span class="nc" id="L88">    }</span>


    public void initializeDefaultGame(int height, int width, String nickname){
        // Инициализация сражающихся-пустышек
<span class="nc" id="L93">        battlers.add(null);</span>
<span class="nc" id="L94">        battlers.add(null);</span>

        // Генерация карты и координат замков
<span class="nc" id="L97">        gameMap = new GameMap(height, width);</span>
<span class="nc" id="L98">        ArrayList&lt;Coordinates&gt; castlesCoordinates = Misc.balancedPositionFor2Castles(gameMap);</span>
<span class="nc" id="L99">        int c1x = castlesCoordinates.get(0).getX();</span>
<span class="nc" id="L100">        int c1y = castlesCoordinates.get(0).getY();</span>
<span class="nc" id="L101">        int c2x = castlesCoordinates.get(1).getX();</span>
<span class="nc" id="L102">        int c2y = castlesCoordinates.get(1).getY();</span>
<span class="nc" id="L103">        this.gameMap.setMapMatrix(gameMap.generateMapMatrix(gameMap.getHeight(),gameMap.getWidth(), c1x, c1y, c2x, c2y));</span>
<span class="nc" id="L104">        this.gameMap.setMatrix(gameMap.generateMapMatrix(gameMap.getHeight(),gameMap.getWidth(), c1x, c1y, c2x, c2y));</span>

        // Инициализация игрока
<span class="nc" id="L107">        ArrayList&lt;Hero&gt; heroes = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L108">        player = new Player(heroes, 20, nickname, this);</span>
<span class="nc" id="L109">        player.setCastle(new Castle(true, &quot;И&quot;, c1x, c1y, player, gameMap));</span>
<span class="nc" id="L110">        player.addHero(new Hero(0,0,&quot;Δ&quot;,10,100,50,1, player));</span>
<span class="nc" id="L111">        player.giveGold(1000);</span>

        // Выдача контроллера игроку (к задумке что при нескольких игроках у каждого был бы свой контроллер, и их был бы целый список?)
<span class="nc" id="L114">        controller = new Controller(gameMap, this);</span>
<span class="nc" id="L115">        controller.setOwner(player);</span>
<span class="nc" id="L116">        this.controllerMenu = controller.getControllerMenu();</span>

        // Ввод дефолтного героя в замок
<span class="nc" id="L119">        player.getCastle().getCastleUI().enterCastle(player.getHeroes().getFirst());</span>

        // Инициализация компьютера
<span class="nc" id="L122">        ArrayList&lt;Hero&gt; computerHeroes = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L123">        computer = new Computer(computerHeroes, 20, player, gameMap, battleMap, this);</span>
<span class="nc" id="L124">        computer.setCastle(new Castle(false, &quot;К&quot;, c2x, c2y, computer, gameMap));</span>
<span class="nc" id="L125">        computer.addHero(new Hero(0,0,&quot;∇&quot;,10,100,50,1, computer));</span>
<span class="nc" id="L126">        computer.addHero(new Hero(0,0,&quot;∇&quot;,10,100,50,1, computer));</span>
<span class="nc" id="L127">        computer.giveGold(1000);</span>
<span class="nc" id="L128">        System.out.println(computer.getNickname());</span>
<span class="nc" id="L129">        computer.acquireWeakArmy();</span>

<span class="nc" id="L131">        gameMap.surroundPointWithFriendlyGrass(c1x, c1y, 3, player);</span>
<span class="nc" id="L132">        gameMap.surroundPointWithFriendlyGrass(c2x, c2y, 3, computer);</span>


        // Добавление игроков в множество игроков
<span class="nc" id="L136">        players.add(player);</span>
<span class="nc" id="L137">        players.add(computer);</span>

        // Получение координат замка
<span class="nc" id="L140">        int cx = computer.getCastle().getX();</span>
<span class="nc" id="L141">        int cy = computer.getCastle().getY();</span>

        // Получение координат замка
<span class="nc" id="L144">        int x = player.getCastle().getX();</span>
<span class="nc" id="L145">        int y = player.getCastle().getY();</span>

        // Размещение замков на &quot;ландшафтной&quot; карте
<span class="nc" id="L148">        gameMap.setMapMatrix(x, y, player.getCastle());</span>
<span class="nc" id="L149">        gameMap.setMapMatrix(cx, cy, computer.getCastle());</span>
        // Размещение на обычной карте
<span class="nc" id="L151">        gameMap.setMatrix(x, y, player.getCastle());</span>
<span class="nc" id="L152">        gameMap.setMatrix(cx, cy, computer.getCastle());</span>

        // Выгрузка всех героев игкрока на карту на вертикали замка
<span class="nc" id="L155">        verticalHeroLoadup(player);</span>

        // Выгрузка всех героев компьютера на карту на вертикали замка
<span class="nc" id="L158">        verticalHeroLoadup(computer);</span>

        // Создание меню
<span class="nc" id="L161">        gameMenu = new GameMenu(this);</span>
<span class="nc" id="L162">        gameMenu.setGameMap(gameMap);</span>
        // Переключение статуса игры
        //status = &quot;buying&quot;;
        // Запуск игрового цикла
<span class="nc" id="L166">        currentlyMoving = player;</span>
<span class="nc" id="L167">    }</span>

    public void initializeCustomMapGame(GameMap map, String nickname){
        // Инициализация сражающихся-пустышек
<span class="nc" id="L171">        battlers.add(null);</span>
<span class="nc" id="L172">        battlers.add(null);</span>

        // Генерация карты и координат замков
<span class="nc" id="L175">        gameMap = map;</span>
<span class="nc" id="L176">        ArrayList&lt;Coordinates&gt; castlesCoordinates = Misc.balancedPositionFor2Castles(gameMap);</span>
<span class="nc" id="L177">        int c1x = castlesCoordinates.get(0).getX();</span>
<span class="nc" id="L178">        int c1y = castlesCoordinates.get(0).getY();</span>
<span class="nc" id="L179">        int c2x = castlesCoordinates.get(1).getX();</span>
<span class="nc" id="L180">        int c2y = castlesCoordinates.get(1).getY();</span>

        // Инициализация игрока
<span class="nc" id="L183">        ArrayList&lt;Hero&gt; heroes = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L184">        player = new Player(heroes, 20, nickname, this);</span>
<span class="nc" id="L185">        player.setCastle(new Castle(true, &quot;И&quot;, c1x, c1y, player, gameMap));</span>
<span class="nc" id="L186">        player.addHero(new Hero(0,0,&quot;Δ&quot;,10,100,50,1, player));</span>
<span class="nc" id="L187">        player.giveGold(1000);</span>


        // Выдача контроллера игроку (к задумке что при нескольких игроках у каждого был бы свой контроллер, и их был бы целый список?)
<span class="nc" id="L191">        controller = new Controller(gameMap, this);</span>
<span class="nc" id="L192">        controller.setOwner(player);</span>
<span class="nc" id="L193">        this.controllerMenu = controller.getControllerMenu();</span>

        // Ввод дефолтного героя в замок
<span class="nc" id="L196">        player.getCastle().getCastleUI().enterCastle(player.getHeroes().getFirst());</span>

        // Инициализация компьютера
<span class="nc" id="L199">        ArrayList&lt;Hero&gt; computerHeroes = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L200">        computer = new Computer(computerHeroes, 20, player, gameMap, battleMap, this);</span>
<span class="nc" id="L201">        computer.setCastle(new Castle(false, &quot;К&quot;, c2x, c2y, computer, gameMap));</span>
<span class="nc" id="L202">        computer.addHero(new Hero(0,0,&quot;∇&quot;,10,100,50,1, computer));</span>
<span class="nc" id="L203">        computer.addHero(new Hero(0,0,&quot;∇&quot;,10,100,50,1, computer));</span>
<span class="nc" id="L204">        computer.giveGold(1000);</span>

<span class="nc" id="L206">        computer.acquireWeakArmy();</span>


        // Размещение дружественной травы вокруг замков
<span class="nc" id="L210">        gameMap.surroundPointWithFriendlyGrass(c1x, c1y, 3, player);</span>
<span class="nc" id="L211">        gameMap.surroundPointWithFriendlyGrass(c2x, c2y, 3, computer);</span>


        // Добавление игроков в множество игроков
<span class="nc" id="L215">        players.add(player);</span>
<span class="nc" id="L216">        players.add(computer);</span>

        // Получение координат замка
<span class="nc" id="L219">        int cx = computer.getCastle().getX();</span>
<span class="nc" id="L220">        int cy = computer.getCastle().getY();</span>

        // Получение координат замка
<span class="nc" id="L223">        int x = player.getCastle().getX();</span>
<span class="nc" id="L224">        int y = player.getCastle().getY();</span>

        // Размещение замков на &quot;ландшафтной&quot; карте
<span class="nc" id="L227">        gameMap.setMapMatrix(x, y, player.getCastle());</span>
<span class="nc" id="L228">        gameMap.setMapMatrix(cx, cy, computer.getCastle());</span>
        // Размещение на обычной карте
<span class="nc" id="L230">        gameMap.setMatrix(x, y, player.getCastle());</span>
<span class="nc" id="L231">        gameMap.setMatrix(cx, cy, computer.getCastle());</span>

        // Выгрузка всех героев игкрока на карту на вертикали замка
<span class="nc" id="L234">        verticalHeroLoadup(player);</span>

        // Выгрузка всех героев компьютера на карту на вертикали замка
<span class="nc" id="L237">        verticalHeroLoadup(computer);</span>

        // Создание меню
<span class="nc" id="L240">        gameMenu = new GameMenu(this);</span>
<span class="nc" id="L241">        gameMenu.setGameMap(gameMap);</span>
        // Переключение статуса игры
        //status = &quot;buying&quot;;
        // Запуск игрового цикла
<span class="nc" id="L245">        currentlyMoving = player;</span>
<span class="nc" id="L246">    }</span>

    public void setGameMenu(GameMenu gameMenu) {
<span class="nc" id="L249">        this.gameMenu = gameMenu;</span>
<span class="nc" id="L250">    }</span>

    public void preGame(){
<span class="nc" id="L253">        render();</span>
<span class="nc" id="L254">        gameCycle();</span>
<span class="nc" id="L255">    }</span>

    public Set&lt;Player&gt; getPlayers() {
<span class="nc" id="L258">        return players;</span>
    }

    public void addLoser(Player player){
<span class="nc" id="L262">        losers.add(player);</span>
<span class="nc" id="L263">    }</span>

    public void setBattle(Battle battle) {
<span class="nc" id="L266">        this.battle = battle;</span>
<span class="nc" id="L267">    }</span>

    public Battle getBattle() {
<span class="nc" id="L270">        return battle;</span>
    }

    public void reloadBattlers() {
<span class="nc" id="L274">        battlers.set(0, battle.getHero1());</span>
<span class="nc" id="L275">        battlers.set(1, battle.getHero2());</span>
<span class="nc" id="L276">    }</span>

    public GameMap getGameMap() {
<span class="nc" id="L279">        return gameMap;</span>
    }

    public GameMap getBattleMap() {
<span class="nc" id="L283">        return battleMap;</span>
    }

    public void verticalHeroLoadup(Player player){
<span class="nc" id="L287">        GameMap map = player.getCastle().getMap();</span>
<span class="nc" id="L288">        int y = player.getCastle().getY();</span>
<span class="nc" id="L289">        int x = player.getCastle().getX();</span>
<span class="nc" id="L290">        int j = 1;</span>
<span class="nc" id="L291">        int dy = j;</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">        for (int i = 0; i &lt; player.getHeroes().size(); i++){</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">            if (i%2 == 0){</span>
<span class="nc" id="L294">                dy = j;</span>
            } else {
<span class="nc" id="L296">                dy = -j;</span>
<span class="nc" id="L297">                j++;</span>
            }
<span class="nc" id="L299">            map.loadEntity(player.getHeroes().get(i), player.getCastle().getX(),y+dy);</span>
        }
<span class="nc" id="L301">    }</span>


    public void render(){
<span class="nc" id="L305">        System.out.println(&quot;\n\n\n\n\n\n\n\n\n\n\n\n&quot;);</span>
<span class="nc" id="L306">        gameMenu.printStatistics(player);</span>
<span class="nc" id="L307">        gameMenu.printStatistics(computer);</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">        if (Objects.equals(status, &quot;global&quot;)) {</span>
<span class="nc" id="L309">            gameMenu.printMoveInterface(0);</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">        } else if (Objects.equals(status, &quot;battle&quot;)) {</span>
<span class="nc" id="L311">            gameMenu.printMoveInterface(1);</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">        } else if (Objects.equals(status, &quot;buying&quot;)) {</span>
<span class="nc" id="L313">            player.getCastle().getCastleUI().startShop();</span>
<span class="nc" id="L314">            status = &quot;global&quot;;</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">        } else if (Objects.equals(status, &quot;endgame&quot;)) {</span>
<span class="nc" id="L316">            gameMenu.printMoveInterface(0);</span>
<span class="nc" id="L317">            gameMenu.printGameOver();</span>
        }
<span class="nc" id="L319">    }</span>

    public void enterCastle(Castle castle, Hero hero){
<span class="nc" id="L322">        castle.getCastleUI().enterCastle(hero);</span>
<span class="nc" id="L323">        setStatus(&quot;buying&quot;);</span>
<span class="nc" id="L324">        render();</span>
<span class="nc" id="L325">    }</span>


    public void beginBattle(Hero hero1, Hero hero2){
<span class="nc" id="L329">        Battle battle = new Battle(hero1, hero2, this);</span>
<span class="nc" id="L330">        gameMenu.refreshBattleMap();</span>
<span class="nc" id="L331">        controller.setGameMap(battleMap);</span>
<span class="nc" id="L332">        controller.setBattling(true);</span>
<span class="nc" id="L333">        computer.setBattleMap(battleMap);</span>
<span class="nc" id="L334">        battlers.set(0, hero1);</span>
<span class="nc" id="L335">        battlers.set(01, hero2);</span>
<span class="nc" id="L336">        currentlyMoving = hero1.getOwner();</span>
<span class="nc" id="L337">        battlers.get(0).getOwner().setBattler(battlers.get(0));</span>
<span class="nc" id="L338">        battlers.get(1).getOwner().setBattler(battlers.get(1));</span>
<span class="nc" id="L339">        battleCycle();</span>
<span class="nc" id="L340">    }</span>

    public void endBattle(){
<span class="nc" id="L343">        setBattleMap(null);</span>
<span class="nc" id="L344">        setStatus(&quot;global&quot;);</span>
<span class="nc" id="L345">        controller.setBattling(false);</span>
<span class="nc" id="L346">        controller.setControlled(null);</span>
<span class="nc" id="L347">        controller.setGameMap(gameMap);</span>
<span class="nc" id="L348">        setBattle(null);</span>
<span class="nc" id="L349">        battlers.set(0, null);</span>
<span class="nc" id="L350">        battlers.set(1, null);</span>
<span class="nc" id="L351">    }</span>

    public Player getCurrentlyMoving() {
<span class="nc" id="L354">        return currentlyMoving;</span>
    }

    public boolean isBattling(){
<span class="nc bnc" id="L358" title="All 2 branches missed.">        return !Objects.isNull(battle);</span>
    }

    public Controller getController() {
<span class="nc" id="L362">        return controller;</span>
    }

    public void gameCycle(){
<span class="nc" id="L366">        boolean flag = true;</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">        while (flag){</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">            if (checkEngame(currentlyMoving)){</span>
<span class="nc" id="L369">                flag = false;</span>
<span class="nc" id="L370">                break;</span>
            }
<span class="nc" id="L372">            this.render();</span>
<span class="nc" id="L373">            gameMap.getWarden().jailIteration(currentlyMoving);</span>
<span class="nc" id="L374">            flag = giveMove(currentlyMoving);</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">            if (currentlyMoving.equals(player)){</span>
<span class="nc" id="L376">                currentlyMoving = computer;</span>
            } else {
<span class="nc" id="L378">                currentlyMoving = player;</span>
            }
        }
<span class="nc" id="L381">        gameMenu.printGameOver();</span>
<span class="nc" id="L382">    }</span>


    public void battleCycle(){
<span class="nc" id="L386">        boolean flag = true;</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">        while (flag){</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">            if (checkEndBattle(currentlyMoving.getBattler())){</span>
<span class="nc" id="L389">                flag = false;</span>
<span class="nc" id="L390">                break;</span>
            }
<span class="nc" id="L392">            this.render();</span>
<span class="nc" id="L393">            battleMap.getWarden().jailIteration(currentlyMoving);</span>
<span class="nc" id="L394">            flag = giveMove(currentlyMoving);</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">            if (currentlyMoving.equals(player)){</span>
<span class="nc" id="L396">                currentlyMoving = computer;</span>
            } else {
<span class="nc" id="L398">                currentlyMoving = player;</span>
            }
        }
<span class="nc" id="L401">        System.out.println(&quot;Битва окончена&quot;);</span>
<span class="nc" id="L402">        currentlyMoving = battlers.getFirst().getOwner();</span>
<span class="nc" id="L403">        endBattle();</span>
<span class="nc" id="L404">    }</span>


    boolean checkEngame(Player player){
<span class="nc bnc" id="L408" title="All 4 branches missed.">        if (player.haveLost() || losers.contains(player)){</span>
<span class="nc" id="L409">            status = &quot;endgame&quot;;</span>
<span class="nc" id="L410">            losers.add(player);</span>
<span class="nc" id="L411">            return true;</span>
        }
<span class="nc" id="L413">        return false;</span>
    }

    boolean checkEndBattle(Hero hero){
<span class="nc bnc" id="L417" title="All 2 branches missed.">        if (!hero.isAlive()){</span>
<span class="nc" id="L418">            gameMap.removeEntity(hero);</span>
<span class="nc" id="L419">            hero.expel();</span>
<span class="nc" id="L420">            return true;</span>
        }
<span class="nc" id="L422">        return false;</span>
    }

    public GameMenu getGameMenu() {
<span class="nc" id="L426">        return gameMenu;</span>
    }

    boolean giveMove(Player player){
<span class="nc bnc" id="L430" title="All 2 branches missed.">        if (!freshlyLoaded){</span>
<span class="nc" id="L431">            replenishPlayerEntities(player);</span>
        }
<span class="nc" id="L433">        freshlyLoaded = false;</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">        if (status.equals(&quot;global&quot;)){</span>
<span class="nc" id="L435">            player.castleCaptureIteration();</span>
        }

<span class="nc bnc" id="L438" title="All 2 branches missed.">        if (player.getType().equals(&quot;COMPUTER&quot;)){</span>
<span class="nc" id="L439">            ((Computer)player).simpleBotMove();</span>
<span class="nc" id="L440">            return true;</span>
        }
<span class="nc bnc" id="L442" title="All 2 branches missed.">        if (Objects.equals(status, &quot;global&quot;)){</span>
<span class="nc" id="L443">            return controllerMenu.moveEntityControlCycle();</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">        } else if (Objects.equals(status, &quot;battle&quot;)) {</span>
<span class="nc" id="L445">            controllerMenu.setBattlingHero(player.getBattler());</span>
<span class="nc" id="L446">            return controllerMenu.moveEntityControlCycle();</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">        } else if (Objects.equals(status, &quot;endgame&quot;)) {</span>
<span class="nc" id="L448">            return false;</span>
        } else{
<span class="nc" id="L450">            System.out.println(&quot;WRONG GIVE MOVE CALL&quot;);</span>
        }
<span class="nc" id="L452">        return false;</span>
    }

    Hero getCurrentlyMovingBattler(){
<span class="nc bnc" id="L456" title="All 2 branches missed.">        for (Hero hero: battlers){</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">            if (hero.getOwner().equals(currentlyMoving)){</span>
<span class="nc" id="L458">                return hero;</span>
            }
<span class="nc" id="L460">        }</span>
<span class="nc" id="L461">        return null;</span>
    }

    void replenishPlayerEntities(Player player){
<span class="nc bnc" id="L465" title="All 4 branches missed.">        if (Objects.equals(status, &quot;global&quot;)){ replenish((Player) player); } else if (Objects.equals(status, &quot;battle&quot;)) {</span>
<span class="nc" id="L466">            battlers.get(0).replenish();</span>
<span class="nc" id="L467">            battlers.get(1).replenish();</span>
        }
<span class="nc" id="L469">    }</span>




    boolean entityIsHeroCapturingCastle(Entity entity){
<span class="nc bnc" id="L475" title="All 4 branches missed.">        return (entity.getType().equals(&quot;hero&quot;) &amp;&amp; ((Hero)entity).isBusyCapturing());</span>
    }

    public void replenish(Player player){
<span class="nc" id="L479">        player.getCastle().replenishIfNoCaptor();</span>
<span class="nc" id="L480">        ArrayList&lt;Hero&gt; heroes = player.getHeroes();</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">        for (Hero value : heroes) {</span>
<span class="nc" id="L482">            ((Entity) value).setCurrentMP(((Entity) value).getDefaultMP());</span>
<span class="nc" id="L483">        }</span>
<span class="nc" id="L484">    }</span>

    boolean entityMovementCycle(Entity entity){
<span class="nc bnc" id="L487" title="All 2 branches missed.">        if (entity.getCurrentMP() &gt; 0){</span>
<span class="nc" id="L488">            System.out.println(&quot;УПРАВЛЕНИЕ СУЩНОСТЬЮ &quot; + entity.getDesign());</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">            if (!giveControl(entity)){</span>
<span class="nc" id="L490">                return false;</span>
            }
<span class="nc" id="L492">            this.render();</span>
<span class="nc" id="L493">            return true;</span>
        }
<span class="nc" id="L495">        return false;</span>
    }


    boolean giveControl(Entity entity){
<span class="nc" id="L500">        gameMenu.printGivingConrtol(entity);</span>
<span class="nc" id="L501">        controller.setControlled(entity);</span>
<span class="nc" id="L502">        return controller.control();</span>
    }

    public void setStatus(String status) {
<span class="nc" id="L506">        this.status = status;</span>
<span class="nc" id="L507">    }</span>

    public String getStatus() {
<span class="nc" id="L510">        return status;</span>
    }

    public void setBattleMap(GameMap battleMap) {
<span class="nc" id="L514">        this.battleMap = battleMap;</span>
<span class="nc" id="L515">        gameMenu.refreshBattleMap();</span>
<span class="nc" id="L516">    }</span>

    public Set&lt;Player&gt; getLosers() {
<span class="nc" id="L519">        return losers;</span>
    }

    /*   boolean controlCycleThroughEntities(Object player, ArrayList&lt;? extends Entity&gt; entities){
        if (entities.isEmpty()){
            System.out.println(&quot;Передано управление пустой армией.&quot;);
            return false;
        }
        if (player instanceof Computer){
            return true;
        }

        if (Objects.equals(status, &quot;global&quot;)){ replenish((Player) player); } else if (Objects.equals(status, &quot;battle&quot;)) {
            battlers.get(0).replenish();
            battlers.get(1).replenish();
        }

        boolean flag = true;
        for (int i = 0; i &lt; entities.size(); i++){
            flag = true;
            Entity entity = (Entity)entities.get(i);
            if (entity.getCurrentMP() &lt;= 0 || entityIsHeroCapturingCastle(entity)){
                continue;
            } else {
                while (flag) {
                    flag = entityMovementCycle(entity);
                }
                System.out.println(&quot;Сущность &quot; + entity.getDesign() + &quot; устала&quot;);
                gameMenu.printUnitExhausted();
            }
            gameMenu.printGivingMove();
        }
        return true;
    }*/
    /*    void keyboardHandler(Entity entity){
        System.out.println(&quot;Ваш ход: &quot;);
        String input = scanner.nextLine();
        System.out.println(&quot;Вы сделали ход &quot; + input + &quot;. Передача хода в обработчик...&quot;);
        act(entity, input);
    }
    String estimateMoves(Entity entity){
        int x = entity.getX();
        int y = entity.getY();
        int Nx = x; int Ny = y+1;
        int Sx = x; int Sy = y-1;
        int Wx = x-1; int Wy = y;
        int Ex = x+1; int Ey = y;

        String result = &quot;У вас нет ходов.&quot;;
        for (int i = 0; i &lt; 4; i++){
            break;
        }
        return result;
    }
    void proceedToCell(Entity entity, Asset cell, int dx, int dy){
        gameMap.increlocate(entity, dx, dy);
        entity.setCurrentMP(entity.getCurrentMP()-((Cell)cell).getCost());
        this.render();
    }*/
    /*void estimateMove(Entity entity, int dx, int dy){
        int x = entity.getX();
        int y = entity.getY();
        x+=dx;
        y+=dy;
        if (x &lt; 0 || y &lt; 0 || x &gt;= gameMap.getWidth() || y&gt;=gameMap.getHeight()){
            System.out.println(&quot;Невозможно пройти наружу&quot;);
        }
        Asset asset = gameMap.getAsset(x, y);
        if (asset.getType() == &quot;cell&quot;){
            proceedToCell(entity, asset, dx, dy);
        } else if (asset.getType() == &quot;entity&quot;) {
            boolean side = ((Entity)asset).getSide();
            if (!side){
                if (entity.getType() == &quot;unit&quot;){
                    System.out.println(&quot;Атаковать юнита &quot; + ((Unit)asset).getType() + &quot;?   \&quot;Да\&quot; - F, \&quot;Отмена\&quot; - C&quot;);
                    String input = scanner.nextLine();
                    attackHandler(input, (Unit) entity,(Unit) asset, &quot;attack&quot;);
                } else {
                    System.out.println(&quot;Впереди враждебный герой. Начать сражение?    \&quot;Да\&quot; - F, \&quot;Отмена\&quot; - C&quot;);
                    String input = scanner.nextLine();
                    attackHandler(input, (Unit) entity,(Unit) asset, &quot;battle&quot;);
                }
            } else {
                System.out.println(&quot;В этом месте уже стоит союзный персонаж.&quot;);
            }
        }
    }*/
   /* void attackHandler(String input, Asset attacker, Asset defender, String type){
        while (true){
            if (input == &quot;F&quot;) {
                if (type == &quot;attack&quot;){
                    beginBattle((Hero) attacker, (Hero) defender);
                    return;
                }
                int dmg = ((Unit)attacker).getDamage();
                ((Unit)defender).setHealth(((Unit)defender).getHealth()-dmg);
                ((Unit)defender).checkHealth();
                return;
            } else if (input == &quot;C&quot;) {
                return;
            } else {
                System.out.println(&quot;Введите F для атаки или C для отмены.&quot;);
            }
        }

    }*/
    /*void act(Entity entity, String action){
        switch (action) {
            case (&quot;W&quot;):
                estimateMove(entity, 0, -1);
                break;
            case (&quot;A&quot;):
                estimateMove(entity, -1, 0);
                break;
            case (&quot;S&quot;):
                estimateMove(entity, 0, 1);
                break;
            case (&quot;D&quot;):
                estimateMove(entity, 1, 0);
                break;
            default:
                break;
        }
    }
*/
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>